(function(){var t,e,r=function(t,e){function r(){this.constructor=t}for(var n in e)i.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},i={}.hasOwnProperty,n=function(t,e){return function(){return t.apply(e,arguments)}};t=require("../web/mylib/CommonJs.js"),e=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return r(e,t),e.prototype.base_path="contents/web/",e.prototype.http=require("http"),e.prototype.mime=require("mime"),e.prototype.sio=require("socket.io"),e.prototype.fs=require("fs"),e.prototype.start=function(t){return null==t&&(t=!1),this.app=this.http.createServer(function(t){return function(e,r){return t.http_server_action(e,r)}}(this)),this.ws_start()},e.prototype.http_server_action=function(t,e){var r,i,n,o,s,c,h,p;return p=t.url.replace(/\/{2,}/,"/"),s=this.get_params(p),p=p.replace(/\?.*$/,""),"/"===p[p.length-1]&&(p+="index.html"),c=""+this.base_path+p,n=this.fs.existsSync(c),n?(r=this.fs.readFileSync(c),h=this.mime.lookup(c),e.writeHead(200,{"Content-Type":h}),e.end(r)):(e.writeHead(404),e.end("404 - file not found")),"html"===p.slice(p.length-4,+(p.length-1)+1||9e9)?(o=t.connection.remoteAddress.replace(/.*[^\d](\d+\.\d+\.\d+\.\d+$)/,"$1"),i=(new Date).toLocaleTimeString(),console.log(i+" "+o+" "+p)):void 0},e.prototype.ws_start=function(){return this.websocket=this.ws_port===this.http_port?this.sio(this.app):this.sio(this.ws_port),this.app.listen(this.http_port),this.websocket.on("connection",function(t){return function(e){return e.on("g",function(r){return t.ws_reload(e,r)})}}(this))},e.prototype.ws_reload=function(t,e){var r,i,n,o,s;for(s=[],n=0,o=e.length;o>n;n++)r=e[n],i=""+this.base_path+r,this.fs.existsSync(i)?s.push(this.fs.watch(i,function(){return function(){return t.emit("reload")}}(this))):s.push(void 0);return s},e}(t),this.App=function(){function t(){this.check_dir_tree_read_dir=n(this.check_dir_tree_read_dir,this),this.check_dir_tree_callback=n(this.check_dir_tree_callback,this),this.check_dir_tree=n(this.check_dir_tree,this),this.downloader=n(this.downloader,this),this.ftp_downloader_fullpath=n(this.ftp_downloader_fullpath,this),this.readline=n(this.readline,this),this.ftp_downloader=n(this.ftp_downloader,this),this.jsdom_check=n(this.jsdom_check,this)}return t.prototype.http=require("http"),t.prototype.https=require("https"),t.prototype.fs=require("fs"),t.prototype.cson=require("cson"),t.prototype.Client=require("ftp"),t.prototype.jsdom=require("jsdom"),t.prototype.jsdom_jquery_source="./contents/web/lib/jquery-2.1.3.min.js",t.prototype.server=new e,t.prototype.jsdom_check=function(t,e){var r;return r=this.fs.readFileSync(this.jsdom_jquery_source,{encoding:"utf-8"}),this.jsdom.env({file:t,src:[r],done:function(){return function(t,r){var i;return i=r.$(e),i.each(function(){return console.log($(this).text())})}}(this)})},t.prototype.ftp_downloader=function(t,e,r,i,n){var o;return o=new this.Client,o.on("ready",function(t){return function(){return o.get(""+r,function(e,r){if(e)throw e;return r.once("close",function(){return o.end()}),r.pipe(t.fs.createWriteStream(n))})}}(this)),o.connect({host:i,user:t,password:e})},t.prototype.readline=function(t){var e,r,i;return e=require("readline"),i=this.fs.ReadStream(t),r=e.createInterface({input:i,output:{}}),r.on("line",function(){return function(t){return console.log(t)}}(this)),r.resume()},t.prototype.ftp_downloader_fullpath=function(t,e){var r,i,n,o;return n=t.replace(/.*\/\/([^:]+).*/,"$1"),o=t.replace(/.*\/\/[^:]+:([^@]+).*/,"$1"),r=t.replace(/.*\/([^/]+$)/,"$1"),i=t.replace(/.*@([^/]+).*/,"$1"),this.ftp_downloader(n,o,r,i,e)},t.prototype.downloader=function(t,e){var r,i,n;return r=this.fs.createWriteStream(e),i=t.match(/^https/)?this.https:this.http,n=i.get(t,function(){return function(t){return t.pipe(r)}}(this))},t.prototype.check_dir_tree=function(t,e,r){return this.check_dir_tree_file_pattern=e,null==r&&(r=void 0),r&&(this.check_dir_tree_callback=r),this.check_dir_tree_read_dir(t)},t.prototype.check_dir_tree_callback=function(){return 1},t.prototype.check_dir_tree_read_dir=function(t){var e,r,i,n,o,s;for(r=this.fs.readdirSync(t),s=[],n=0,o=r.length;o>n;n++)e=r[n],i=""+t+e,this.fs.lstatSync(i).isDirectory()?s.push(this.check_dir_tree_read_dir(""+t+e+"/")):e.match(this.check_dir_tree_file_pattern)?s.push(this.check_dir_tree_callback(i,e)):s.push(void 0);return s},t}(),module.exports=this.App}).call(this);